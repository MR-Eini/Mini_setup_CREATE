library(SWATprepR)
library(SWATfarmR)
library(SWATtunR)
library(SWATdoctR)
source('settings.R')
source('functions.R')
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
traceback()
library(SWATprepR)
library(SWATfarmR)
library(SWATtunR)
library(SWATdoctR)
source('settings.R')
source('functions.R')
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## Workflow for Uncalibrated Setup Preparation ---------------------------------
##
## Version 0.0.9
## Date: 2025-07-26
## Developers: Svajunas Plunge    svajunas_plunge@sggw.edu.pl
##             Christoph Sch√ºrz   christoph.schuerz@ufz.de
##             Micheal Strauch    michael.strauch@ufz.de
##
##
# # If the package 'remotes' is not installed run first:
# install.packages("remotes")
#
# remotes::install_github("biopsichas/SWATtunR")
# remotes::install_github("biopsichas/SWATprepR")
# remotes::install_github("tkdweber/euptf2")
# remotes::install_github("chrisschuerz/SWATfarmR")
# remotes::install_github("chrisschuerz/SWATrunR")
# remotes::install_git("https://git.ufz.de/schuerz/swatdoctr.git")
# remotes::install_git("https://git.ufz.de/schuerz/swatmeasr.git")
# ------------------------------------------------------------------------------
## Please read before starting!!! The preparation of input data is not part of
## this workflow and needs to be done externally. However, if you have already
## prepared and tested the data using the scripts provided by the developer
## team, you can proceed with this setup generation workflow. Its primary
## objective is to regenerate the complete setup in (hopefully) a single run.
## This could be crucial if you've updated the input data, discovered errors in
## the setup, and more. The workflow enables you to progress from pre-processed
## data to a pre-calibrated model setup. Additionally, you can utilize other
## workflows provided by the development team for soft and hard calibration/
## validation of the model, running scenarios, etc.
##------------------------------------------------------------------------------
##
##------------------------------------------------------------------------------
library(SWATprepR)
library(SWATfarmR)
library(SWATtunR)
library(SWATdoctR)
source('settings.R')
source('functions.R')
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
library(SWATprepR)
library(SWATfarmR)
library(SWATtunR)
library(SWATdoctR)
source('settings.R')
source('functions.R')
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
##------------------------------------------------------------------------------
##
##------------------------------------------------------------------------------
library(SWATprepR)
library(SWATfarmR)
library(SWATtunR)
library(SWATdoctR)
source('settings.R')
source('functions.R')
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
##------------------------------------------------------------------------------
##
##------------------------------------------------------------------------------
library(SWATprepR)
library(SWATfarmR)
library(SWATtunR)
library(SWATdoctR)
source('settings.R')
source('functions.R')
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(res_path)) unlink(res_path, recursive = TRUE)
## Creating results directory
dir.create(res_path, recursive = TRUE)
##------------------------------------------------------------------------------
## 2) Running SWATbuildR'er
##------------------------------------------------------------------------------
## Please make sure SWATbuildR'er settings are provided in settings file
source(paste0(lib_path, '/buildr_script/swatbuildr.R'), chdir=TRUE)
##----------------------------------------------------------------------
## Identifying path to the database
db_path <- list.files(path = res_path, pattern = paste0(project_name, ".sqlite"),
recursive = TRUE, full.names = TRUE)
if(length(db_path)>1){
stop(paste0("You have more than one database named ",
paste0(project_name, ".sqlite in you working directory.
Please remove/rename or set path to db manually!!")))
} else if (length(db_path) == 0) {
stop("No database found!")
} else {
# Define destination path inside res_path
dest_db_path <- file.path(res_path, paste0(project_name, ".sqlite"))
# Copy database to res_path
file.copy(db_path, dest_db_path, overwrite = TRUE)
# Create zip in res_path
zip(file.path(res_path, "db_backup.zip"), dest_db_path)
# Delete the copied .sqlite file from res_path
file.remove(dest_db_path)
}
## Loading weather data and downloading atmospheric deposition
# met <- load_template(weather_path, 4326)
#
# ## Fixed input values
# met$data$ID2$RELHUM$RELHUM <- ifelse(met$data$ID2$RELHUM$RELHUM >= 0,
#                                      met$data$ID2$RELHUM$RELHUM/100,
#                                      met$data$ID2$RELHUM$RELHUM)
met <- readRDS(weather_path)
## Calculating weather generator statistics
wgn <- prepare_wgn(met)
## Adding weather and atmospheric deposition data into setup
add_weather(db_path, met, wgn)
## This is needed for write.exe to work (writing a dot in project_config table)
db <- dbConnect(RSQLite::SQLite(), db_path)
project_config <- dbReadTable(db, 'project_config')
project_config$input_files_dir <- "."
dbWriteTable(db, 'project_config', project_config, overwrite = TRUE)
dbDisconnect(db)
## Directory of setup .sqlite database
dir_path <- file.path(dirname(db_path))
## Copy write.exe into TxtInOut directory and run it
## (In case you get error in this step the workaround can be opening database
## with SWATPluseditor and writing SWAT input files with it.)
exe_copy_run(lib_path, dir_path, "write.exe")
## Downloading atmospheric deposition data
df <- get_atmo_dep(substring(bound_path, nchar(out_path)+1, nchar(bound_path)))
## Adding atmospheric deposition data to the model setup
add_atmo_dep(df, dir_path, t_ext = "annual")
link_aquifer_channels(dir_path)
## Overwriting plants.plt with adjusted manually
file.copy(paste0(lib_path, "/files_to_overwrite_at_the_end/plants.plt"), dir_path,
overwrite = TRUE)
## Setting directory and running Micha's SWAtfarmR'er input script
in_dir <- paste0(lib_path, "/farmR_input")
source(paste0(in_dir, "/write_SWATfarmR_input.R"), chdir=TRUE)
## Coping results into results folder
files <- list.files(in_dir, pattern = "\\.csv$")
out_dir <- paste0(res_path, "/farmR_input")
if (dir.exists(out_dir)) unlink(out_dir, recursive = TRUE)
dir.create(out_dir)
file.copy(paste0(in_dir, "/", files), paste0(res_path, "/farmR_input"))
## Cleaning calculation directory
file.remove(paste0(in_dir, "/", files))
##------------------------------------------------------------------------------
## 10) Additional editing of the farmR_input.csv file
##------------------------------------------------------------------------------
#
# ## Reading the file
mgt <- paste0(out_dir, "/farmR_input.csv")
## Backing up landuse.lum file
if(!file.exists(paste0(dir_path, "/", "landuse.lum.bak"))) {
file.copy(from = paste0(dir_path, "/", "landuse.lum"),
to = paste0(dir_path, "/", "landuse.lum", ".bak"), overwrite = TRUE)
}
## Updating it
source(paste0(lib_path, '/read_and_modify_landuse_lum.R'))
## Updating single value of labile phosphorus in nutrients.sol
f_write <- paste0(dir_path, "/", "nutrients.sol")
nutrients.sol <- read.delim(f_write)
nutrients.sol[2,1] <- gsub("5.00000", lab_p, nutrients.sol[2,1])
update_file(nutrients.sol, f_write)
##Including connecting nutrients.sol into hru-data.hru
if(!file.exists(paste0(dir_path, '/hru-data.hru.bkp0'))) {
copy_file_version(dir_path, 'hru-data.hru', file_version = 0)
}
hru_data <- SWATtunR::read_tbl(paste0(dir_path, "/hru-data.hru.bkp0"))
hru_data$soil_plant_init <- "soilplant1"
hru_data_fmt <- c('%8s', '%-14s', rep('%18s', 8))
SWATreadR:::write_tbl(hru_data, paste0(dir_path, '/hru-data.hru'), fmt = hru_data_fmt)
## Reading time.sim
f_write <- paste0(dir_path, "/", "time.sim")
time_sim <- read.delim(f_write)
## Updating with values provided in settings
y <- as.numeric(unlist(strsplit(time_sim[2,1], "\\s+"))[-1])
if(min(y[y>0]) != st_year){
time_sim[2,1] <- gsub(min(y[y>0]), st_year, time_sim[2,1])
}
if(max(y[y>0]) != end_year){
time_sim[2,1] <- gsub(max(y[y>0]), end_year, time_sim[2,1])
}
##Writing out updated time.sim file
update_file(time_sim, f_write)
source(paste0(lib_path, '/create_connectivity_line_shape.R'))
print(paste0("land_connections_as_lines.shp is prepared in ", dir_path,
'/data folder' ))
##Copy swat.exe into txtinout directory and run it
exe_copy_run(lib_path, dir_path, swat_exe)
## Adding missing fertilizers and tillage
if(!file.exists(paste0(dir_path, '/fertilizer.frt.bkp0'))) {
copy_file_version(dir_path, 'fertilizer.frt', file_version = 0)
}
fertilizer.frt <- SWATtunR::read_tbl(paste0(dir_path, "/fertilizer.frt.bkp0"))
fertilizer.frt[nrow(fertilizer.frt)+1,] <- list("comp_manure", 0.0021, 0.0016, 0.0017, 0.008, 0.99, "fresh_manure", "Comp_FreshManure")
fertilizer.frt[nrow(fertilizer.frt)+1,] <- list("7:20:30", 0.02, 0.08728, 0, 0, 0, "null", "NPK")
fertilizer_frt_fmt <- c('%-18s', rep('%12s', 5), '%18s', '%-30s')
SWATreadR:::write_tbl(fertilizer.frt, paste0(dir_path, '/fertilizer.frt'), fmt = fertilizer_frt_fmt)
if(!file.exists(paste0(dir_path, '/tillage.til.bak0'))) {
copy_file_version(dir_path, 'tillage.til', file_version = 0)
}
tillage.til <- SWATtunR::read_tbl(paste0(dir_path, "/tillage.til.bkp0"))
tillage.til[nrow(tillage.til )+1,] <- list("plow25", 0.95, 250, 75, 0, 0, "plowingoperation25cm")
tillage_til_fmt <- c('%-18s', rep('%12s', 5), '%-40s')
SWATreadR:::write_tbl(tillage.til, paste0(dir_path, '/tillage.til'), fmt = tillage_til_fmt)
## Generating .farm project
if(startsWith(as.character(packageVersion("SWATfarmR")), "4.")){
frm <- SWATfarmR::farmr_project$new(project_name = 'frm', project_path = dir_path,
project_type = 'environment')
.GlobalEnv$frm <- frm
} else if(startsWith(as.character(packageVersion("SWATfarmR")), "3.2.0")){
frm <- SWATfarmR::farmr_project$new(project_name = 'frm', project_path = dir_path)
} else {
stop("SWATfarmR version should be > 4.0.0 or special version 3.2.0
from OPTAIN Cloud>WPs&Tasks>WP4>Task4.4>Tools to share>workflow_scripts>SWATfarmR_3.2.0.zip")
}
## Adding dependence to precipitation
api <- variable_decay(frm$.data$variables$pcp, -5,0.8)
asgn <- select(frm$.data$meta$hru_var_connect, hru, pcp)
frm$add_variable(api, "api", asgn)
## Reading schedules, scheduling operations and writing management files
frm$read_management(mgt, discard_schedule = TRUE)
frm$schedule_operations(start_year = 1995, end_year = 2021,
replace = 'all')
# save.image(file = "my_environment.RData")
frm$write_operations(start_year = 1995, end_year = 2021)
# Overwriting with a set of manually adjusted files (if needed). Except plants.plt
# which was overwritten in the step 9
# Directory could be empty, if you don't have any files to be used.
file.copy(grepl("plants.plt", list.files(
path = paste0(lib_path, "/files_to_overwrite_at_the_end"), full.names = TRUE)),
dir_path, overwrite = TRUE)
## Dealing with unconnected reservoirs
if(!file.exists(paste0(dir_path, '/reservoir.con.bkp0'))) copy_file_version(dir_path, 'reservoir.con', file_version = 0)
if(!file.exists(paste0(dir_path, '/reservoir.res.bkp0'))) copy_file_version(dir_path, 'reservoir.res', file_version = 0)
if(!file.exists(paste0(dir_path, '/hydrology.res.bkp0'))) copy_file_version(dir_path, 'hydrology.res', file_version = 0)
reservoir_con <- readLines(paste0(dir_path, "/reservoir.con.bkp0"))
reservoir_res <- readLines(paste0(dir_path, "/reservoir.res.bkp0"))
hydrology_res <- readLines(paste0(dir_path, "/hydrology.res.bkp0"))
for(i in c(3:length(reservoir_con))){
if(substr(reservoir_con[i], start = 160, stop = 160) == "0" | grepl("aqu       1             rhg", reservoir_con[i], fixed = TRUE)){
reservoir_con[i] <- paste0(substr(reservoir_con[i], start = 1, stop = 159), "1           aqu         1           rhg       1.00000  ")
reservoir_res[i] <- paste0(substr(reservoir_res[i], start = 1, stop = 67), "         null           sedres1           nutres1  ")
hydrology_res[i] <- paste0(substr(hydrology_res[i], start = 1, stop = 101), "10000       0.80000       0.00000       0.00000  ")
} else {
hydrology_res[i] <- paste0(substr(hydrology_res[i], start = 1, stop = 101), "00000       0.80000       0.00000       0.00000  ")
}
}
writeLines(reservoir_con, paste0(dir_path, "/", "reservoir.con"))
writeLines(reservoir_res, paste0(dir_path, "/", "reservoir.res"))
writeLines(hydrology_res, paste0(dir_path, "/", "hydrology.res"))
## Copy swat.exe into txtinout directory and run it
exe_copy_run(lib_path, dir_path, swat_exe)
## Preparing directory
clean_path <- paste0(res_path, "/", "clean_setup")
## If the directory exists, delete the results directory. (Please be careful!!!)
if (file.exists(clean_path)) unlink(clean_path, recursive = TRUE)
## Creating results directory
dir.create(clean_path, recursive = TRUE)
## Coping only input files
file.copy(setdiff(list.files(path = dir_path, full.names = TRUE),
list.files(path = dir_path,
pattern = ".*.txt|.*.zip|.*success.fin|.*co2.out|.*write.exe|.*simulation.out|.*.bak|.*.mgts|.*.farm|.*area_calc.out|.*checker.out|.*sqlite|.*diagnostics.out|.*erosion.out|.*files_out.out|.*.swf", full.names = TRUE)),
clean_path)
cat("Congradulations!!! You have pre-calibrated model!!! \n
Please continue to soft-calibration workflow (softcal_workflow.R)")
print(paste0("Your setup is located in the ", getwd(), "/", clean_path))
##------------------------------------------------------------------------------
## 21) Adding calibration.cal file to SWAT model (preparing calibrated setup)
##------------------------------------------------------------------------------
stop("Remove this if you have calibration.cal file")
cal_file_nb <- 1
cal_file <- paste0(lib_path, "/calibration_cal/calibration", as.character(cal_file_nb), ".cal")
file.copy(from = cal_file,
to = paste0(clean_path, "/calibration.cal"), overwrite = TRUE)
## Updating file.cio file
file_cio <- readLines(paste0(clean_path, "/", "file.cio"))
if(!grepl("calibration.cal", file_cio[22], fixed = TRUE)){
file_cio[22] <- "chg               cal_parms.cal     calibration.cal   null              null              null              null              null              null              null              "
writeLines(file_cio, paste0(clean_path, "/", "file.cio"))
}
